<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <style>
			#welcome-container {
				font-family: Sans-Serif;
			}
		
			#upload_results2 {
				max-height:300px;
				overflow-y:scroll;
				border: 2px solid #009879;
				display:none;
			}
			
			#upload_results3 {
				max-height:100px;
				overflow-y:scroll;
				border: 2px solid #009879;
				display:none;
				background-color:#222;
			}
			
			#upload_results3 span{
				display:block;
				color:#00ff00;
				font-family: monospace;				
			}
		
			#upload_results2 table {
				border-collapse: collapse;
				font-size: 0.9em;
				font-family: sans-serif;
				width:100%;
			}
			
			#upload_results2 table th,
			#upload_results2 table td {
				padding: 12px 15px;
			}
			#upload_results2 table tbody tr {
				border-bottom: 1px solid #dddddd;
			}

			#upload_results2 table tbody tr:nth-of-type(even) {
				background-color: #f3f3f3;
			}	
			
			#upload_results2 table tbody tr:first-child {
				background-color: #009879;
				color: #ffffff;
				text-align: left;
			}	
		</style>
    </head>

    <body class="m-0">
        <div class="py-4">
            <div class="container" id="welcome-container">
                <h2>Welcome to the <strong>Specimen Data Refinery</strong>, part of SYNTHESIS+</h2>
				<p>Insert some text about the project here</p>
				<h3>Bulk upload</h3>
				<p>This form can be used to schedule multiple digitisations at once.</p>
				<p>Currently this bulk upload feature only supports up to 10 images at a time.</p>
				<p>Uploads must be in the following format:
					<ul>
						<li>Comma separated value file, containing the following columns
							<ul>
								<li>Catalog number</li>
								<li>Image license	</li>
								<li>Image URI</li>
								<li>Object type</li>
								<li>Rights holder</li>
								<li>Institution URL</li>
								<li>Higher classification</li>
								<li>Person name</li>
								<li>Person identifier</li>
							</ul>
						</li>
						<li>CSV assumes headers and that all columns are present</li>
					</ul>
				</p>
                <form>
			        Upload 
			        <br/>
			        <input type="file" id="fileinput"/>
				</form>
				<div id="upload_results1"></div>
				<div id="upload_results2"></div>
				<div id="upload_results3"></div>
				<script>
				var lines = "";
				var index = 0;
				var selectedWorkflow = "";
				
					function logInvocations() {
						index++;
						var specimen = lines[index].split(",");
								
						var span = document.createElement("span");
						span.innerHTML = "Submitted specimen " + specimen[0];
						document.getElementById("welcome-container").appendChild(span);
								
						var xhr = new XMLHttpRequest();
						xhr.open("POST", selectedWorkflow + "/invocations", false);
						xhr.setRequestHeader('Content-Type', 'application/json');
						xhr.send(JSON.stringify({
							history: "hist_id=" + document.getElementById("Histories").value,
							inputs : {
								"Catalog number": specimen[0],
								"Image license": specimen[1],
								"Image URI": specimen[2],
								"Object type": specimen[3],
								"Rights holder": specimen[4],
								"Institution URL": specimen[5],
								"Higher classification": specimen[6],
								"Person name": specimen[7],
								"Person identifier": specimen[8]
							},
							inputs_by: 'name'
						}));
						
						xhr.onload = function() {
						    if (xhr.status != 200) { // analyze HTTP status of the response
								var span = document.createElement("span");
								span.innerHTML = "Successfully submitted specimen " + specimen[0];
								document.getElementById("upload_results3").appendChild(span);
							} else { // show the result
								var span = document.createElement("span");
								span.innerHTML = "ERROR: failed to submit specimen " + specimen[0];
								document.getElementById("upload_results3").appendChild(span);
							}
						};
						setTimeout(logInvocations, 0);
					}
				
					function runWorkflows(evt) {
						document.getElementById("upload_results3").style.display = "block";
						selectedWorkflow = document.getElementById("Workflows").value;
						index = 0;
						logInvocations(lines, 0);
						top.document.getElementById("history-refresh-button").click();
					}
				
				    function readSingleFile(evt) {
						var f = evt.target.files[0]; 
						if (f) {
							document.getElementById("upload_results2").style.display = "block";
							var success_text = "";
							var r = new FileReader();
                            r.onload = function(e) { 
								var contents = e.target.result;
								success_text = "File Uploaded! <br />" + "name: " + f.name + "<br />" + "type: " + f.type + "<br />" + "size: " + f.size + " bytes <br />";
								lines = contents.split("\n"), output = [];
								for (var i=0; i<lines.length; i++) {
								    output.push("<tr><td>" + lines[i].split(",").join("</td><td>") + "</td></tr>");
								}
								output = "<table>" + output.join("") + "</table>";
								document.getElementById('upload_results1').innerHTML = success_text;
								document.getElementById('upload_results2').innerHTML = output;
						    }
							r.readAsText(f);
							
							//create dropdown to choose workflow
							
							    var xmlHttp = new XMLHttpRequest();
								xmlHttp.open( "GET", "https://sdr.nhm.ac.uk/api/workflows", false ); // false for synchronous request
								xmlHttp.send( null );
								var workflows = JSON.parse(xmlHttp.responseText);
								var select = document.createElement("select");
								select.name = "Workflows";
								select.id = "Workflows"
								workflows.forEach(function(element){
								var option = document.createElement("option");
									option.text = element["name"];
									option.value = element["url"];
									select.appendChild(option);
									}
								);
								var label = document.createElement("label");
								label.innerHTML = "Choose your workflow: "
								label.htmlFor = "Workflows";

								document.getElementById("welcome-container").appendChild(label).appendChild(select);
								
								
								//create dropdown to choose history
								
															    var xmlHttp = new XMLHttpRequest();
								xmlHttp.open( "GET", "https://sdr.nhm.ac.uk/api/histories", false ); // false for synchronous request
								xmlHttp.send( null );
								var histories = JSON.parse(xmlHttp.responseText);
								var select1 = document.createElement("select");
								select1.name = "Histories";
								select1.id = "Histories"
								histories.forEach(function(element){
								var option = document.createElement("option");
									option.text = element["name"];
									option.value = element["id"];
									select1.appendChild(option);
									}
								);
								var label1 = document.createElement("label");
								label1.innerHTML = "Choose your history: "
								label1.htmlFor = "Histories";

								document.getElementById("welcome-container").appendChild(label1).appendChild(select1);
								
								let btn = document.createElement("button");
								btn.innerHTML = "Run workflow";
								btn.addEventListener('click', runWorkflows);
								document.getElementById("welcome-container").appendChild(btn);

						} 
						else { 
						    alert("Failed to load file");
					    }
				    }
			 	    document.getElementById('fileinput').addEventListener('change', readSingleFile);			
				</script>			
            </div>
        </div>
    </body>
</html>