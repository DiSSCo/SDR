<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <style>
			#welcome-container {
				font-family: Sans-Serif;
			}
			#upload_results {
				height:70px;

				border: 2px solid #009879;
				padding:12px 15px;
				display:none;
				background-color: #009879;
				color: #ffffff;
								font-family: monospace;	
			}
			#upload_results2 {
				max-height:300px;
				overflow-y:scroll;
				border: 2px solid #009879;
				display:none;

			}
			
			#upload_results3 {
				height:200px;
				overflow-y:scroll;
				border: 2px solid #009879;
				display:none;
				background-color: #009879;
								padding:12px 15px;
			}
			#upload_buttons {
				padding:12px 15px;
			}
			#upload_buttons button{
				background-color: #009879;
				padding:12px 15px;
				color:white;
				margin-top:10px;
			}
			#upload_results3 span{
				display:block;
				color: #ffffff;
				font-family: monospace;				
			}
		
			#upload_results2 table {
				border-collapse: collapse;
				font-size: 0.9em;
				font-family: sans-serif;
				width:100%;
			}
			
			#upload_results2 table th,
			#upload_results2 table td {
				padding: 12px 15px;
			}
			#upload_results2 table tbody tr {
				border-bottom: 1px solid #dddddd;
			}

			#upload_results2 table tbody tr:nth-of-type(even) {
				background-color: #f3f3f3;
			}	
			
			#upload_results2 table tbody tr:first-child {
				background-color: #009879;
				color: #ffffff;
				text-align: left;
			}	
			#fileinput{
				display:block;
				padding:0.46em 1.6em;
				margin:0 0.2em 0.2em 0;
				border-radius:0.12em;
				box-sizing: border-box;
				text-decoration:none;
				width:100%;
				color:#fff;
				background-color:#009879;
				text-align:center;
			}

		</style>
    </head>

    <body class="m-0">
        <div class="py-4">
            <div class="container" id="welcome-container">
                <h2>Welcome to the <strong>Specimen Data Refinery</strong>, part of SYNTHESIS+</h2>
				<p>Insert some text about the project here</p>
				<h3>Bulk upload</h3>
				<p>This form can be used to schedule multiple digitisations at once.</p>
				<div id="wf-holder"></div>
				
				<p>Uploads must be in the following format:
					<ul>
						<li>Comma separated value file, containing the following columns
							<ul id="wf-inputs">
							</ul>
						</li>
						<li>CSV assumes headers and that all columns are present</li>
					</ul>
				</p>
                <form>
			        <input type="file" id="fileinput"/>
				</form>
				<div id="upload_results"></div>
				<div id="upload_results1"></div>
				<div id="upload_results2"></div>
				<div id="upload_buttons"></div>
				<div id="upload_results3"></div>
				<script>
				
				
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.open( "GET", "https://sdr.nhm.ac.uk/api/workflows", false ); // false for synchronous request
				xmlHttp.send( null );
				var workflows = JSON.parse(xmlHttp.responseText);
				var select = document.createElement("select");
				select.name = "Workflows";
				select.id = "Workflows"
				workflows.forEach(function(element){
				var option = document.createElement("option");
					option.text = element["name"];
					option.value = element["url"];
					select.appendChild(option);
					}
				);
				var label = document.createElement("label");
				label.innerHTML = "Choose your workflow: "
				label.htmlFor = "Workflows";

				document.getElementById("wf-holder").appendChild(label).appendChild(select);
				
				var lines = "";
				var index = 1;
				var selectedWorkflow = "";
				var start = "";
				
					function InvokeWorkflow() {
						
						var specimen = lines[index].split(",");
		
						var xhr = new XMLHttpRequest();
						xhr.open("POST", selectedWorkflow + "/invocations", false);
						xhr.setRequestHeader('Content-Type', 'application/json');
						var payload = JSON.stringify({
							history: "hist_id=" + document.getElementById("Histories").value,
							inputs : {
								"Catalog number": specimen[0],
								"Image license": specimen[1],
								"Image URI": specimen[2],
								"Object type": specimen[3],
								"Rights holder": specimen[4],
								"Institution URL": specimen[5],
								"Higher classification": specimen[6],
								"Person name": specimen[7],
								"Person identifier": specimen[8]
							},
							inputs_by: 'name'
						});
						xhr.send(payload);
						
						var span = document.createElement("span");
						span.innerHTML = (new Date().getTime() - start) + "ms > Submitting specimen " + specimen[0] + " with payload: " + payload;
						var logDiv = document.getElementById("upload_results3");
						logDiv.appendChild(span);
						logDiv.innerHTML += "<br/>";
						logDiv.scrollTop = logDiv.scrollHeight;
						top.document.getElementById("history-refresh-button").click();
						
						if(index < lines.length)
						{
							index++;
							setTimeout(InvokeWorkflow, 0);
						}
					}
				
					function runWorkflows(evt) {
						document.getElementById("upload_results3").style.display = "block";
						selectedWorkflow = document.getElementById("Workflows").value;
						index = 1;
						start = new Date().getTime();
						InvokeWorkflow();
					}
				
				    function readSingleFile(evt) {
						var f = evt.target.files[0]; 
						if (f) {
							document.getElementById("upload_results2").style.display = "block";
							var success_text = "";
							var r = new FileReader();
                            r.onload = function(e) { 
								var contents = e.target.result;
								success_text = "File Uploaded! <br />" + "name: " + f.name + "<br />" + "type: " + f.type + "<br />" + "size: " + f.size + " bytes <br />";
								lines = contents.split("\n"), output = [];
								for (var i=0; i<lines.length; i++) {
								    output.push("<tr><td>" + lines[i].split(",").join("</td><td>") + "</td></tr>");
								}
								output = "<table>" + output.join("") + "</table>";
								document.getElementById('upload_results').innerHTML = success_text;
								document.getElementById("upload_results").style.display = "block";
								document.getElementById('upload_results2').innerHTML = output;
						    }
							r.readAsText(f);
							
							//create dropdown to choose workflow
							

								
								
								//create dropdown to choose history
								
								var xmlHttp = new XMLHttpRequest();
								xmlHttp.open( "GET", "https://sdr.nhm.ac.uk/api/histories", false ); // false for synchronous request
								xmlHttp.send( null );
								var histories = JSON.parse(xmlHttp.responseText);
								var select1 = document.createElement("select");
								select1.name = "Histories";
								select1.id = "Histories"
								histories.forEach(function(element){
								var option = document.createElement("option");
									option.text = element["name"];
									option.value = element["id"];
									select1.appendChild(option);
									}
								);
								var label1 = document.createElement("label");
								label1.innerHTML = "Choose your history: "
								label1.htmlFor = "Histories";

								document.getElementById("upload_buttons").appendChild(label1).appendChild(select1);
								document.getElementById("upload_buttons").innerHTML += "<br/>";
								
								let btn = document.createElement("button");
								btn.innerHTML = "Run workflow";
								btn.addEventListener('click', runWorkflows);
								document.getElementById("upload_buttons").appendChild(btn);

						} 
						else { 
						    alert("Failed to load file");
					    }
				    }
			 	    document.getElementById('fileinput').addEventListener('change', readSingleFile);			
				</script>			
            </div>
        </div>
    </body>
</html>